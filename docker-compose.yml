services:
  kafka:
    image: apache/kafka:4.1.1
    container_name: guardianpay-kafka
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      CLUSTER_ID: MDEyMzQ1Njc4OTAxMjM0NQ
    ports:
      - "9092:9092"
    healthcheck:
      test: ["CMD", "/opt/kafka/bin/kafka-topics.sh", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 5s
      retries: 15
    profiles: ["core", "full", "tools"]

  kafka-init:
    image: apache/kafka:4.1.1
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./infra/kafka/create-topics.sh:/scripts/create-topics.sh:ro
    command: ["/bin/bash", "/scripts/create-topics.sh"]
    profiles: ["core", "full", "tools"]

  redis:
    image: redis:8-alpine
    container_name: guardianpay-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "PING"]
      interval: 10s
      timeout: 4s
      retries: 10
    profiles: ["core", "full"]

  neo4j:
    image: neo4j:5.26
    container_name: guardianpay-neo4j
    environment:
      NEO4J_AUTH: neo4j/guardianpay
      NEO4J_server_memory_heap_initial__size: 512m
      NEO4J_server_memory_heap_max__size: 512m
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
    healthcheck:
      test: ["CMD", "cypher-shell", "-a", "bolt://localhost:7687", "-u", "neo4j", "-p", "guardianpay", "RETURN 1"]
      interval: 15s
      timeout: 8s
      retries: 20
    profiles: ["core", "full"]

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: guardianpay-clickhouse
    environment:
      CLICKHOUSE_DB: guardianpay
      CLICKHOUSE_USER: guardianpay
      CLICKHOUSE_PASSWORD: guardianpay
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD", "clickhouse-client", "--user", "guardianpay", "--password", "guardianpay", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 20
    profiles: ["core", "full"]

  opa:
    image: openpolicyagent/opa:0.70.0
    container_name: guardianpay-opa
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "--set=decision_logs.console=true"
      - "/policies"
    ports:
      - "8181:8181"
    volumes:
      - ./infra/opa:/policies:ro
    profiles: ["core", "full"]

  simulator:
    build:
      context: ./python/simulator
    container_name: guardianpay-simulator
    environment:
      KAFKA_BROKERS: kafka:9092
      TOPIC_TX_RAW: tx.raw
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    ports:
      - "8090:8090"
    profiles: ["core", "full"]

  feature-stream:
    build:
      context: ./python/feature-stream
    container_name: guardianpay-feature-stream
    environment:
      KAFKA_BROKERS: kafka:9092
      TOPIC_TX_RAW: tx.raw
      TOPIC_TX_FEATURE: tx.feature
      KAFKA_GROUP_ID: feature-stream-v2
      KAFKA_AUTO_OFFSET_RESET: latest
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    profiles: ["core", "full"]

  graph-service:
    build:
      context: .
      dockerfile: rust/Dockerfile.service
      args:
        BIN_NAME: graph-service
    container_name: guardianpay-graph-service
    environment:
      KAFKA_BROKERS: kafka:9092
      TOPIC_TX_RAW: tx.raw
      TOPIC_TX_GRAPH: tx.graph
      KAFKA_GROUP_ID: graph-service-v2
      KAFKA_AUTO_OFFSET_RESET: latest
      NEO4J_URI: neo4j://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: guardianpay
      GRAPH_BIND: 0.0.0.0:8084
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      neo4j:
        condition: service_healthy
    ports:
      - "8084:8084"
    profiles: ["core", "full"]

  risk-decider:
    build:
      context: .
      dockerfile: rust/Dockerfile.service
      args:
        BIN_NAME: risk-decider
    container_name: guardianpay-risk-decider
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_GROUP_ID: risk-decider-v2
      KAFKA_AUTO_OFFSET_RESET: latest
      TOPIC_TX_RAW: tx.raw
      TOPIC_TX_FEATURE: tx.feature
      TOPIC_TX_GRAPH: tx.graph
      TOPIC_TX_DECISION: tx.decision
      TOPIC_TX_DEADLETTER: tx.deadletter
      OPA_URL: http://opa:8181/v1/data/guardianpay/decision
      MODEL_VERSION: model-v1
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      opa:
        condition: service_started
    profiles: ["core", "full"]

  analytics-writer:
    build:
      context: .
      dockerfile: rust/Dockerfile.service
      args:
        BIN_NAME: analytics-writer
    container_name: guardianpay-analytics-writer
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_GROUP_ID: analytics-writer-v2
      KAFKA_AUTO_OFFSET_RESET: latest
      TOPIC_TX_DECISION: tx.decision
      TOPIC_TX_GRAPH: tx.graph
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DB: guardianpay
      CLICKHOUSE_USER: guardianpay
      CLICKHOUSE_PASSWORD: guardianpay
      ANALYTICS_BIND: 0.0.0.0:8083
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      clickhouse:
        condition: service_healthy
    ports:
      - "8083:8083"
    profiles: ["core", "full"]

  gateway-api:
    build:
      context: .
      dockerfile: rust/Dockerfile.service
      args:
        BIN_NAME: gateway-api
    container_name: guardianpay-gateway-api
    environment:
      KAFKA_BROKERS: kafka:9092
      TOPIC_TX_RAW: tx.raw
      TOPIC_TX_DECISION: tx.decision
      SIMULATOR_URL: http://simulator:8090
      ANALYTICS_URL: http://analytics-writer:8083
      GRAPH_API_URL: http://graph-service:8084
      GATEWAY_BIND: 0.0.0.0:8080
    depends_on:
      kafka-init:
        condition: service_completed_successfully
      simulator:
        condition: service_started
      analytics-writer:
        condition: service_started
      graph-service:
        condition: service_started
    ports:
      - "8080:8080"
    profiles: ["core", "full"]

  dashboard:
    build:
      context: ./dashboard
    container_name: guardianpay-dashboard
    environment:
      VITE_GATEWAY_URL: http://localhost:8080
      VITE_WS_URL: ws://localhost:8080/v1/stream/alerts
    depends_on:
      gateway-api:
        condition: service_started
    ports:
      - "5173:5173"
    profiles: ["core", "full"]

  checkout-demo:
    build:
      context: ./demo/checkout
    container_name: guardianpay-checkout-demo
    ports:
      - "8787:80"
    profiles: ["core", "full"]

  replay-cli:
    build:
      context: .
      dockerfile: rust/Dockerfile.service
      args:
        BIN_NAME: replay-cli
    container_name: guardianpay-replay-cli
    environment:
      KAFKA_BROKERS: kafka:9092
      TOPIC_TX_RAW: tx.raw
      TOPIC_TX_FEATURE: tx.feature
      TOPIC_TX_GRAPH: tx.graph
      TOPIC_TX_DECISION: tx.decision
      MODEL_VERSION: model-v1
      REPLAY_MAX_MESSAGES: 200000
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    profiles: ["tools"]

  quality-evaluator:
    build:
      context: ./python/quality-evaluator
    container_name: guardianpay-quality-evaluator
    environment:
      KAFKA_BROKERS: kafka:9092
      TOPIC_TX_DECISION: tx.decision
      QUALITY_MAX_MESSAGES: 200000
      QUALITY_REVIEW_IS_FRAUD: "true"
      QUALITY_MIN_PRECISION: 0.70
      QUALITY_MIN_RECALL: 0.75
      QUALITY_OUTPUT_PATH: /out/quality-report.json
    volumes:
      - ./artifacts:/out
    depends_on:
      kafka-init:
        condition: service_completed_successfully
    profiles: ["tools"]

  flink-jobmanager:
    image: flink:2.1.1-scala_2.12-java17
    container_name: guardianpay-flink-jobmanager
    command: jobmanager
    environment:
      - JOB_MANAGER_RPC_ADDRESS=flink-jobmanager
    ports:
      - "8081:8081"
    profiles: ["full"]

  flink-taskmanager:
    image: flink:2.1.1-scala_2.12-java17
    container_name: guardianpay-flink-taskmanager
    command: taskmanager
    environment:
      - JOB_MANAGER_RPC_ADDRESS=flink-jobmanager
    depends_on:
      - flink-jobmanager
    profiles: ["full"]

  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: guardianpay-prometheus
    volumes:
      - ./infra/observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    profiles: ["full"]

  loki:
    image: grafana/loki:3.2.1
    container_name: guardianpay-loki
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - ./infra/observability/loki.yaml:/etc/loki/local-config.yaml:ro
    ports:
      - "3100:3100"
    profiles: ["full"]

  tempo:
    image: grafana/tempo:2.6.1
    container_name: guardianpay-tempo
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./infra/observability/tempo.yaml:/etc/tempo.yaml:ro
    ports:
      - "3200:3200"
      - "4317:4317"
    profiles: ["full"]

  grafana:
    image: grafana/grafana:11.3.1
    container_name: guardianpay-grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: guardianpay
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki
      - tempo
    profiles: ["full"]

volumes:
  neo4j_data:
  clickhouse_data:
